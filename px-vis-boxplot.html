<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../px-vis/px-vis-scale.html">
<link rel="import" href="../px-vis/px-vis-svg.html">
<link rel="import" href="../px-vis/px-vis-axis.html">
<link rel="import" href="../px-vis/px-vis-threshold.html">
<link rel="import" href="px-vis-box-whisker.html">

<link rel="import" href="../px-vis/px-vis-behavior-colors.html">
<link rel="import" href="../px-vis/px-vis-behavior-common.html">
<link rel="import" href="../px-vis/px-vis-behavior-chart.html">

<link rel="import" href="css/px-vis-boxplot-styles.html">


<dom-module id="px-vis-boxplot">
  <template>
    <style include="px-vis-boxplot-styles"></style>

    <px-vis-svg
      width="[[width]]"
      height="[[height]]"
      margin="[[margin]]"
      svg="{{svg}}">
    </px-vis-svg>
    <px-vis-scale
      x-axis-type="[[xAxisType]]"
      y-axis-type="[[yAxisType]]"
      complete-series-config="[[completeSeriesConfig]]"
      chart-extents="[[chartExtents]]"
      data-extents="[[dataExtents]]"
      width="[[width]]"
      height="[[height]]"
      margin="[[margin]]"
      chart-data="[[chartData]]"
      x="{{x}}"
      y="{{y}}"
      domain-changed="{{domainChanged}}">
    </px-vis-scale>
    <!-- y axis -->
    <px-vis-axis
      id="yAxis"
      svg="[[layer.1]]"
      axis="[[y]]"
      axis-type="[[yAxisType]]"
      margin="[[margin]]"
      width="[[width]]"
      height="[[height]]"
      title="Y Axis"
      orientation="left"
      label-position="center"
      prevent-series-bar
      complete-series-config="[[completeSeriesConfig]]"
      muted-series=[[mutedSeries]]
      domain-changed="[[domainChanged]]">
    </px-vis-axis>
    <!-- x axis -->
    <px-vis-axis
      id="xAxis"
      svg="[[layer.1]]"
      axis="[[x]]"
      axis-type="[[xAxisType]]"
      margin="[[margin]]"
      width="[[width]]"
      height="[[height]]"
      title="X Axis"
      orientation="bottom"
      label-position="center"
      prevent-series-bar
      complete-series-config="[[completeSeriesConfig]]"
      muted-series=[[mutedSeries]]
      domain-changed="[[domainChanged]]">
    </px-vis-axis>
    <!-- box and whisker components -->
    <template is="dom-repeat" items="[[chartData]]" restamp>
      <px-vis-box-whisker
        series-key="[[_getBoxWhiskerSeriesKey(item)]]"
        complete-series-config="[[completeSeriesConfig]]"
        data="[[_getBoxWhiskerData(item)]]"
        position="[[_getBoxWhiskerPosition(item)]]"
        orientation="[[orientation]]"
        svg="[[layer.1]]"
        x="[[x]]"
        y="[[y]]"
        box-width="[[_boxWidth]]"
        edge-width="[[_edgeWidth]]"
        domain-changed="[[domainChanged]]"
        mean-radius="[[boxWhiskerConfig.meanRadius]]"
        outlier-radius="[[boxWhiskerConfig.outlierRadius]]"
        draw-debounce-time="[[boxWhiskerConfig.drawDebounceTime]]">
      </px-vis-box-whisker>
    </template>
    <!-- threshold lines -->
    <px-vis-threshold
      id="threshold"
      svg="[[layer.2]]"
      complete-series-config="[[completeSeriesConfig]]"
      threshold-data="[[thresholdData]]"
      threshold-config="[[thresholdConfig]]"
      width="[[width]]"
      height="[[height]]"
      margin="[[margin]]"
      x="[[x]]"
      y="[[y]]"
      type="[[thresholdType]]"
      domain-changed="[[domainChanged]]"
      show-threshold-box="[[showThresholdBox]]"
      language="[[language]]">
    </px-vis-threshold>

  </template>
  <script>
    Polymer({

      is: 'px-vis-boxplot',

      behaviors: [
        PxColorsBehavior.dataVisColors,
        PxColorsBehavior.dataVisColorTheming,
        PxColorsBehavior.getSeriesColors,
        PxVisBehavior.axisTypes,
        PxVisBehavior.baseSize,
        PxVisBehavior.chartExtents,
        PxVisBehavior.completeSeriesConfig,
        PxVisBehavior.dataset,
        PxVisBehavior.dataExtents,
        PxVisBehavior.margins,
        PxVisBehavior.observerCheck,
        PxVisBehavior.seriesId,
        PxVisBehavior.thresholds,
        PxVisBehavior.updateStylesOverride,
        PxVisBehaviorD3.domainUpdate,
        PxVisBehaviorChart.axisConfigs,
        PxVisBehaviorChart.layers,
        PxVisBehaviorChart.subConfiguration,
        PxVisBehaviorChart.thresholdConfig
      ],

      properties: {

        /**
         * An array of objects that contain data for each box and whisker
         * component on the box plot chart.
         *
         * ```
         * [{
         *   series1: {
         *     position: 1,
         *     data: {
         *       max: 90,
         *       q3: 70,
         *       mean: 50,
         *       median: 50,
         *       q1: 30,
         *       min: 10,
         *       outliers: [5, 2]
         *     }
         *   },
         *   series2: {
         *     position: 1,
         *     data: {
         *       max: 90,
         *       q3: 70,
         *       mean: 50,
         *       median: 50,
         *       q1: 30,
         *       min: 10,
         *       outliers: [5, 2]
         *     }
         *   }
         * }]
         * ```
         */
        chartData: {
          type: Array,
          value: [],
          notify: true
        },

        // TODO: import behavior PxVisBehaviorChart.chartCommon
        seriesConfig: {
          type: Object
        },

        /**
        * Defines the base margin for the chart. Calcs are run to add to the margin
        * to accommodate axes and other elements which exist within the SVG frame,
        * but outside the chart frame.
        */
        margin: {
          type: Object,
          value: function() {
            return {
              'top': 10,
              'right': 10,
              'bottom': 50,
              'left': 50
            };
          }
        },

        /**
         * Configuration object used to configure the box and whisker
         * components.  Refer to px-vis-box-whisker.html for a list
         * of valid properties.
         */
        boxWhiskerConfig: {
          type: Object
        },

        /**
         * Padding between boxes.
         */
        scalePadding: {
          type: Number,
          value: 0.5
        },

        /**
         * Direction of the box plot chart.  The values can be
         * 'vertical' or 'horizontal'.
         */
        orientation: {
          type: String,
          value: 'vertical'
        },

        /**
         * Sets the orientation of the threshold line. Applicable values:
         *
         * `x`: Threshold line will be vertical. Aligning with a value on the x-axis.
         * `y`: Threshold line will be horizontal. Aligning with a value on the y-axis.
         */
        thresholdType: {
          type: String,
          value: 'y'
        },

        _defaultColor: {
          type: String,
          value: '#000'
        },

        _boxWidth: {
          type: Number
        },

        _edgeWidth: {
          type: Number
        }

      },

      observers: [
        '_chartDataChanged(chartData, chartData.*, scalePadding)',
        '_boxWhiskerConfigChanged(boxWhiskerConfig)',
        '_orientationChanged(orientation)',
        '_xAxisConfigChanged(xAxisConfig)',
        '_yAxisConfigChanged(yAxisConfig)',
        '_thresholdConfigChanged(thresholdConfig)',
        '_updateStyles(_stylesUpdated)',
        '_updateSeriesConfig(seriesConfig)',
        '_setScalePadding(domainChanged, x, y)'
      ],

      listeners: {
        'px-data-vis-colors-applied': '_updateSeriesConfig'
      },

      ready: function() {
        this.set('numberOfLayers', 5);
      },

      _chartDataChanged: function(chartData) {
        if (!chartData || chartData.length < 1) {
          return;
        }
        this.dataExtents = this._calcDataExtents(chartData);
      },

      _orientationChanged(orientation) {
        // update axis and threshold types
        if (orientation === 'horizontal') {
          this.xAxisType = 'linear';
          this.yAxisType = 'scaleBand';
          this.thresholdType = 'x';
        } else {
          this.xAxisType = 'scaleBand';
          this.yAxisType = 'linear';
          this.thresholdType = 'y';
        }
        // update extents
        this.dataExtents = this._calcDataExtents(this.chartData);
      },

      _calcDataExtents: function(chartData) {
        if (!chartData) {
          console.warn('Cannot update data extents as chartData is null');
          return;
        }
        const exts = {};
        // set x axis to match the data items
        exts.x = [];
        chartData.forEach((item) => exts.x.push(this._getBoxWhiskerPosition(item)));
        exts.y = [Number.MAX_SAFE_INTEGER, Number.MIN_SAFE_INTEGER];
        // to find the min/max y values, we need to check each set of data
        for (const i in chartData) {
          const data = this._getBoxWhiskerData(chartData[i]);
          const outliersMin = Math.min.apply(Math, data.outliers);
          const outliersMax = Math.max.apply(Math, data.outliers);
          // compare current min/max, current series min/max, and the min/max of outliers
          exts.y = [
            Math.min(exts.y[0], data.min, outliersMin),
            Math.max(exts.y[1], data.max, outliersMax)
          ];
        }
        // if the orientation is horizontal, we actually need to swap our extents
        if (this.orientation === 'horizontal') {
          const y = exts.y;
          exts.y = exts.x;
          exts.x = y;
        }
        return exts;
      },

      /**
       * Returns name of the series for an object from the
       * chartData array. Used mainly by template.
       */
      _getBoxWhiskerSeriesKey: function(item) {
        return Object.keys(item)[0];
      },

      /**
       * Returns box plot data from an object in the
       * chartData array. Used mainly by template.
       */
      _getBoxWhiskerData: function(item) {
        return item[Object.keys(item)[0]].data;
      },

      /**
       * Returns box plot position value from an object in the
       * chartData array. Used mainly by template.
       */
      _getBoxWhiskerPosition: function(item) {
        return item[Object.keys(item)[0]].position;
      },

      _boxWhiskerConfigChanged: function(conf) {
        if (this.hasUndefinedArguments(arguments)) {
          return;
        }
        const comps = this.shadowRoot.querySelectorAll('px-vis-box-whisker');
        if (comps) {
          comps.forEach(function(comp) {
            this._applyConfigToElement(this.boxWhiskerConfig, comp);
          }.bind(this));
        }
      },

      _xAxisConfigChanged: function(xAxisConfig) {
        if (this.hasUndefinedArguments(arguments)) {
          return;
        }
        this._applyConfigToElement(xAxisConfig, this.$.xAxis);
      },

      _yAxisConfigChanged: function(yAxisConfig) {
        if (this.hasUndefinedArguments(arguments)) {
          return;
        }
        this._applyConfigToElement(yAxisConfig, this.$.yAxis);
      },

      _thresholdConfigChanged: function(thresholdConfig) {
        if (this.hasUndefinedArguments(arguments)) {
          return;
        }
        this._applyConfigToElement(thresholdConfig, this.$.threshold);
        // TODO: remove this - currently threshold doesn't update automatically if config changes
        this.$.threshold.drawElement();
      },

      _updateSeriesConfig: function() {
        this.debounce('_updateSeriesConfig', function() {
          const seriesConfig = this.seriesConfig || this._generateSeriesConfig(this.chartData);
          this.set('completeSeriesConfig', seriesConfig);
        }, 10);
      },

      /**
       * Generates seriesConfig object based on chartData. Used if application does
       * not define its own seriesConfig.
       */
      _generateSeriesConfig: function(chartData) {
        const seriesConfig = {};
        chartData.forEach((item) => {
          const seriesKey = this._getBoxWhiskerSeriesKey(item);
          seriesConfig[seriesKey] = {
            name: seriesKey,
            x: 'position',
            y: 'data'
          };
        });
        return seriesConfig;
      },

      _updateStyles: function(_stylesUpdated) {
        console.info('updated styles');
      },

      _setScalePadding: function() {
        if (this.hasUndefinedArguments(arguments)) {
          return;
        }
        const scaleFunc = this.orientation === 'horizontal' ? this.y : this.x;
        if (scaleFunc.paddingOuter) {
          scaleFunc.paddingOuter(this.scalePadding);
          this._boxWidth = scaleFunc.bandwidth();
          this._edgeWidth = this._boxWidth / 3;
        }
      }

    });
  </script>
</dom-module>
